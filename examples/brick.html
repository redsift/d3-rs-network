<html>
  <head>
    <link rel="stylesheet" type="text/css" href="https://static.redsift.io/reusable/ui-rs-core/latest/css/ui-rs-core.min.css">
    <style>

    .links line {
      stroke: #222;
      stroke-opacity: 0.6;
    }

    .nodes circle {
      stroke: #888;
      fill-opacity:  0.2;
      stroke-width: 1.5px
    }
    .textNetwork{
      font-size: 10px
    }
    .ipText{
      visibility: hidden;
      fill: red
    }
    .guidText{
      visibility: visible;
      fill: #F4F
    }
    .macText{
      visibility: hidden;
      fill: #0044FF
    }
    .ipCircle{
      fill:peru
    }
    .macCircle{
      fill: paleturquoise
    }

    </style> 
  </head>
  <body>
    <div id="elm"></div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/d3-rs-network.umd-es2015.min.js"></script>
    <script>


      let DATA = [
        {
          instance: "instance-guid-1",
          metrics: {
            "ping": {
              data: [
                {
                  mac: "32:64:23:34",
                  attributes: {
                    ifacename: "eth0",
                    ipv4: [ "192.168.0.15" ],
                    ipv6: []
                  },
                  epoch: 1523876698,
                  series: [
                    { "offset-ns": 1900899929, "from": "192.168.0.15", "to": "192.168.0.16", "value": { "ns": 5034000, "error": "lost-packet" }},
                    { "offset-ns": 1900899929, "to": "8.8.8.8", "value-ns": 15034000 },
                    { "offset-ns": 1900999929, "to": "192.168.0.16", "value-ns": 3034000 }
                  ]
                },
                {
                  mac: "32:64:23:34",
                  attributes: {
                    ifacename: "eth1",
                    ipv4: [ "192.168.0.16" ],
                    ipv6: []
                  },
                  epoch: 1523876698,
                  series: [
                    { "offset-ns": 1900899929, "from": "192.168.0.16", "to": "192.168.0.15", "value-ns": 5034000, "error": "lost-packet" },
                    { "offset-ns": 1900899929, "to": "8.8.8.8", "value-ns": 15034000 },
                    { "offset-ns": 1900999929, "to": "192.168.0.16", "value-ns": 3034000 }
                  ]
                }
              ]
            }
          }
        },
        {
          instance: "instance-guid-2"        
        }
      ];

      // let GROUP = {
      //   "ldn-02-stg": { metadata: "something" }
      // };
      // let GUID_TO_MAC = 
      //   {"instance-guid-1": ["mac_32_64_23_34"]}
      // ;
      // let MAC_TO_GUID = 
      //   {"mac_32_64_23_34": "instance-guid-1"}
      // ;
      // let MAC_TO_IP = 
      //   {"mac_32_64_23_34": ["192.168.0.15", "192.168.0.16" ]}
      // ;
      // let IP_To_MAC = {
      //   "ip_192_168_0_15" : "mac_32_64_23_34",
      //   "ip_192_168_0_16" : "mac_32_64_23_34" 
      // }
      // ;

      // strata is 0 for grand-father, 1 for father, and 2 for child
      let VIZ = {
      "nodes": [
        { id: "grandparent1", strata: 0 },
        {id: "parent1", strata: 1},
        {id: "child1", strata: 2},
        { id: "grandparent2", strata: 0 }
        // ...
      ],
      "links": [
        { source: "grandparent1", target: "grandparent2", value: 10.34, color: 'red' }
        // ...
      ],
      "owns": [
        { parent: "grandparent1", child: "parent1" },
        { parent: "parent1", child: "child1" },
        // ...
      ]
      };

      // let VIZ = {
      //   "nodes": [
      //     {"id" : "instance-guid_to", "numChildren":0},
      //     {"id": "instance-guid-1_from", "group": "instance-guid-1", "numChildren":0},
      //     {"id": "instance-guid-1", "numChildren":1}
      //   ],
      //   "mac":[
      //     {"id" : "mac_32_64_23_34", "type":"MAC", "numChildren":2}
      //   ],
      //   "ip":[
      //     {"id": "ip_192_168_0_15", "type":"IP", "numChildren":0},
      //     {"id": "ip_192_168_0_16", "type":"IP", "numChildren":0},
      //     {"id": "ip_162_42_42_15", "type":"IP", "numChildren":0},
      //     {"id": "ip_8_8_8_8", "group": "public-internet", "numChildren":0}
      //   ],
      //   "links": [
      //     {"source": "instance-guid-1_from", "target": "instance-guid_to", "value": 10.34, "epochBegin": 42 ,"typeCom":"transfer" },
      //   ],
      //   "ipLinks":[
      //     {"source": "ip_192_168_0_15", "target": "ip_162_42_42_15", "value": 2 ,"typeCom":"transfer" },
      //     {"source": "ip_192_168_0_16", "target": "ip_162_42_42_15", "value": 2 ,"typeCom":"transfer" },
      //     {"source": "mac_32_64_23_34", "target": "ip_192_168_0_15", "value": 15 ,"typeCom":"parent" },
      //     {"source": "mac_32_64_23_34", "target": "ip_192_168_0_16", "value": 15 ,"typeCom":"parent" }
      //   ],
      //   "relationshipsMacToGuid":[MAC_TO_GUID],
      //   "relationshipsGuidToMac":[GUID_TO_MAC],
      //   "relationshipsMacToIp":[MAC_TO_IP]
      // };
      
      function category(d) {
        // logic
        return GROUP[d.group].metadata;
      }

      function tryGetChildren(idObj){
        // Look into VIZ.owns and find all the cases where parent is idObj
        var arrayChildren = [];
        VIZ.owns.forEach(element => {
          if (element.parent == idObj)
            arrayChildren.add(element.child);
        });
        return arrayChildren;
      }

      function tryGetParent(idObj){
        var parent = null;
        VIZ.owns.forEach(element => {
          if (element.child == idObj)
            parent = elemen.parent;
        });
        return parent;
      }

      var chart = d3_rs_network.html('blank').category(category)
      .tryGetChildren(tryGetChildren).tryGetParent(tryGetParent)
      ;
      
      // modify chart
      d3.select('#elm').datum(VIZ).call(chart);

    </script>
  </body>
</html>
